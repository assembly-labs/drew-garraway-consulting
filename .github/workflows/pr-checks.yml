name: PR Quality Checks

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Detect which projects have changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      tomo: ${{ steps.changes.outputs.tomo }}
      scout: ${{ steps.changes.outputs.scout }}
      career-chat: ${{ steps.changes.outputs.career-chat }}
      f_this_app: ${{ steps.changes.outputs.f_this_app }}
      mikey-real: ${{ steps.changes.outputs.mikey-real }}
      cool-curriculum: ${{ steps.changes.outputs.cool-curriculum }}
      gather: ${{ steps.changes.outputs.gather }}
      luka: ${{ steps.changes.outputs.luka }}
      fhm: ${{ steps.changes.outputs.fhm }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            tomo:
              - 'TOMO/prototype/**'
            scout:
              - 'scout/**'
            career-chat:
              - 'career-chat/**'
            f_this_app:
              - 'f_this_app/**'
            mikey-real:
              - 'Mikey-real/**'
            cool-curriculum:
              - 'cool-curriculum/**'
            gather:
              - 'gather/prototype/**'
            luka:
              - 'luka/**'
            fhm:
              - 'fhm/**'

  # TOMO - React 19 + Vite + TypeScript
  check-tomo:
    needs: detect-changes
    if: needs.detect-changes.outputs.tomo == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: TOMO/prototype
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: TOMO/prototype/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run lint --if-present

  # Scout - React 18 + Vite + TypeScript
  check-scout:
    needs: detect-changes
    if: needs.detect-changes.outputs.scout == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scout
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scout/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run lint --if-present

  # Career Chat - React 19 + Vite + TypeScript
  check-career-chat:
    needs: detect-changes
    if: needs.detect-changes.outputs.career-chat == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: career-chat
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: career-chat/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run test:run --if-present
      - run: npm run lint --if-present

  # F This App - Next.js 16 + React 19
  check-f-this-app:
    needs: detect-changes
    if: needs.detect-changes.outputs.f_this_app == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: f_this_app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: f_this_app/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run lint --if-present

  # Mikey-real - React 19 + Vite + PWA
  check-mikey-real:
    needs: detect-changes
    if: needs.detect-changes.outputs.mikey-real == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Mikey-real
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Mikey-real/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run lint --if-present

  # Cool Curriculum - React 19 + CRA
  check-cool-curriculum:
    needs: detect-changes
    if: needs.detect-changes.outputs.cool-curriculum == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cool-curriculum/ai-lesson-planner
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cool-curriculum/ai-lesson-planner/package-lock.json
      - run: npm ci
      - run: npm run build

  # Gather - React 19 + Vite
  check-gather:
    needs: detect-changes
    if: needs.detect-changes.outputs.gather == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gather/prototype
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gather/prototype/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run lint --if-present

  # Luka - Static HTML + Tailwind CLI
  check-luka:
    needs: detect-changes
    if: needs.detect-changes.outputs.luka == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: luka
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: luka/package-lock.json
      - run: npm ci
      - run: npm run build

  # FHM - Vanilla JS + Node scripts
  check-fhm:
    needs: detect-changes
    if: needs.detect-changes.outputs.fhm == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fhm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: fhm/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run lint --if-present
