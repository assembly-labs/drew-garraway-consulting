<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="description" content="Understanding the $36 Trillion U.S. Treasury Market - Who owns America's debt?">

    <title>U.S. Treasury Market Analysis | Franklin Hugh Money</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;500&family=Inter:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Plotly.js for visualizations -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>

    <!-- Main Styles -->
    <link rel="stylesheet" href="../assets/css/main.css?v=14e2242d">
    <!-- Night Mode (5pm - 9am) -->
    <script src="../assets/js/night-mode.js"></script>

    <!-- Treasury-specific overrides -->
    <style>
        /* Treasury page-specific styles */
        h1 {
            margin-bottom: var(--fh-space-xl);
        }

        h2 {
            border-bottom: 2px solid var(--fh-navy);
            padding-bottom: var(--fh-space-sm);
        }

        h3 {
            color: var(--fh-gray-700);
        }

        p {
            max-width: 65ch;
        }

        .header {
            padding: var(--fh-space-2xl) 0;
            margin-bottom: var(--fh-space-2xl);
        }
    </style>
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="container container--wide">
        <nav class="nav nav--inline" style="margin-bottom: var(--fh-space-md);">
            <a href="../index.html">Home</a>
            <a href="training/index.html">Training</a>
            <a href="#" class="active" style="color: var(--fh-burgundy);">Insights</a>
        </nav>
        <nav class="nav nav--inline" style="font-size: 0.85rem;">
            <a href="#overview">Overview</a>
            <a href="#pie-chart">Pie Chart</a>
            <a href="#treemap">Treemap</a>
            <a href="#flow">Flow Diagram</a>
        </nav>

        <header class="header">
            <h1>Who Owns the $36 Trillion U.S. Treasury Market?</h1>
            <p class="lead">
                Understanding the distribution of U.S. government debt reveals the complex web of domestic and international stakeholders
                that finance America's operations. This analysis visualizes the December 2025 ownership structure of the world's largest bond market.
            </p>
        </header>

        <!-- Data Overview Table -->
        <section id="overview" class="viz-section">
            <h2>Ownership Breakdown</h2>

            <!-- Data Status Legend -->
            <div class="data-legend">
                <span class="legend-item">ðŸŸ¢ <strong>Verified:</strong> Official government sources</span>
                <span class="legend-item">ðŸŸ¡ <strong>Estimated:</strong> Industry reports &amp; historical patterns</span>
                <button type="button" id="expandAllBtn" class="control-btn">Expand All</button>
            </div>

            <table class="data-table enhanced">
                <thead>
                    <tr>
                        <th width="5%"></th>
                        <th width="35%">Holder</th>
                        <th class="amount" width="15%">Amount</th>
                        <th class="percentage" width="10%">Share</th>
                        <th width="20%">Data Source</th>
                        <th class="change" width="15%">YoY Change</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </section>

        <!-- SIE Exam Key Concepts -->
        <section class="sie-footnotes">
            <h3>ðŸŽ“ SIE Exam Key Concepts</h3>
            <div id="sieNotesContainer">
                <!-- Will be populated by JavaScript -->
            </div>
        </section>

        <!-- Key Insights -->
        <div class="insight-box">
            <h3>Key Insights</h3>
            <ul>
                <li>The U.S. government itself holds 37.5% through the Federal Reserve and intragovernmental accounts</li>
                <li>Foreign holders control nearly a quarter (23.5%) of all U.S. debt</li>
                <li>Domestic private investors (mutual funds, banks, pensions) own 39% combined</li>
                <li>The Federal Reserve's $6.5T position makes it one of the largest single holders</li>
            </ul>
        </div>

        <!-- Pie Chart -->
        <section id="pie-chart" class="viz-section">
            <h2>Traditional Ownership View</h2>
            <div id="pieChart" class="viz-container">
                <div class="loading">Loading visualization</div>
            </div>
            <p class="viz-description">
                A classic pie chart showing the relative size of each holder category.
                The largest holders are emphasized with expanded slices.
            </p>
        </section>

        <!-- Treemap -->
        <section id="treemap" class="viz-section">
            <h2>Hierarchical Distribution</h2>
            <div id="treemapChart" class="viz-container">
                <div class="loading">Loading visualization</div>
            </div>
            <p class="viz-description">
                A space-efficient treemap visualization where each rectangle's area corresponds to the holder's share of the total debt.
            </p>
        </section>

        <!-- Sankey Diagram -->
        <section id="flow" class="viz-section">
            <h2>Ownership Flow Analysis</h2>
            <div id="sankeyChart" class="viz-container">
                <div class="loading">Loading visualization</div>
            </div>
            <p class="viz-description">
                This flow diagram traces how the $36 trillion in Treasury debt flows from issuance to three major categories
                (Government, Domestic Private, Foreign), then to specific holder types.
            </p>
        </section>

        <footer class="footer footer--spaced">
            <p class="footer__text">
                Data as of December 2025 | Analysis by <a href="../index.html">Franklin Hugh Money</a>
            </p>
            <p class="footer__disclaimer">
                An investment in knowledge pays the best interest.
            </p>
        </footer>
    </div>

    <script>
        // Enhanced data structure with verified/estimated subcategories
        const treasuryHoldings = {
            metadata: {
                totalDebt: 36.0,
                asOf: "December 2024",
                sources: {
                    primary: "U.S. Treasury Bulletin Q3 2024",
                    foreign: "TIC Data October 2024",
                    federal: "Federal Reserve H.4.1 Release",
                    intragovt: "Monthly Statement of Public Debt"
                }
            },
            categories: {
                'Federal Reserve': {
                    total: 6.5,
                    status: 'verified',
                    source: 'SOMA Holdings Report',
                    yoyChange: '+2.3%',
                    breakdown: {
                        'Bills (< 1 year)': { amount: 0.4, status: 'verified', change: '+0.3%' },
                        'Notes (1-10 years)': { amount: 4.2, status: 'verified', change: '+1.8%' },
                        'Bonds (10-30 years)': { amount: 1.6, status: 'verified', change: '+0.2%' },
                        'TIPS (Inflation-Protected)': { amount: 0.3, status: 'verified', change: '0.0%' }
                    },
                    sieNote: "The Federal Reserve conducts Open Market Operations (OMO) through 23 authorized Primary Dealers. Treasury purchases are a key tool of monetary policy. Know the difference between monetary policy (Fed) and fiscal policy (Congress/Treasury)."
                },
                'Intragovernmental Holdings': {
                    total: 6.8,
                    status: 'verified',
                    source: 'Treasury MSPD',
                    yoyChange: '+1.8%',
                    breakdown: {
                        'Social Security Trust Fund': { amount: 2.9, status: 'verified', change: '+0.8%' },
                        'Medicare Trust Funds': { amount: 0.4, status: 'verified', change: '+0.1%' },
                        'Federal Retirement Funds': { amount: 1.8, status: 'verified', change: '+0.5%' },
                        'Other Government Accounts': { amount: 1.7, status: 'verified', change: '+0.4%' }
                    },
                    sieNote: "Government Account Series (GAS) securities are non-marketable and cannot be traded. Trust funds are legally required to invest surpluses in special-issue Treasury securities. These holdings represent IOUs from one part of government to another."
                },
                'Foreign Official Holders': {
                    total: 8.5,
                    status: 'verified',
                    source: 'TIC Data Oct 2024',
                    yoyChange: '-0.5%',
                    breakdown: {
                        'Japan': { amount: 1.13, status: 'verified', change: '-0.2%' },
                        'China': { amount: 0.77, status: 'verified', change: '-0.8%' },
                        'United Kingdom': { amount: 0.75, status: 'verified', change: '+0.3%' },
                        'Luxembourg': { amount: 0.41, status: 'verified', change: '+0.1%' },
                        'Belgium': { amount: 0.36, status: 'verified', change: '+0.2%' },
                        'Ireland': { amount: 0.33, status: 'verified', change: '+0.1%' },
                        'Canada': { amount: 0.32, status: 'verified', change: '0.0%' },
                        'Cayman Islands': { amount: 0.31, status: 'verified', change: '+0.4%' },
                        'Switzerland': { amount: 0.30, status: 'verified', change: '-0.1%' },
                        'France': { amount: 0.28, status: 'verified', change: '+0.1%' },
                        'All Other Countries': { amount: 3.54, status: 'verified', change: '-0.6%' }
                    },
                    sieNote: "U.S. Treasuries are considered risk-free in USD terms and serve as reserve assets for foreign central banks. The 'petrodollar' system and trade surpluses drive foreign Treasury accumulation. Note: Cayman Islands holdings often represent hedge fund custody accounts."
                },
                'U.S. Mutual Funds & ETFs': {
                    total: 6.8,
                    status: 'verified',
                    source: 'Fed Z.1 Report',
                    yoyChange: '+1.2%',
                    breakdown: {
                        'Bond Mutual Funds': { amount: 3.1, status: 'estimated', change: '+0.5%', basis: 'ICI data' },
                        'Money Market Funds': { amount: 2.2, status: 'estimated', change: '+0.4%', basis: 'ICI data' },
                        'Treasury ETFs': { amount: 1.0, status: 'estimated', change: '+0.2%', basis: 'ETF.com' },
                        'Target-Date Funds': { amount: 0.5, status: 'estimated', change: '+0.1%', basis: 'Morningstar' }
                    },
                    sieNote: "Money Market Funds must maintain stable $1.00 NAV and invest in securities maturing in 397 days or less. Treasury ETFs trade on exchanges with intraday pricing, unlike mutual funds which price once daily at NAV. Know the difference between open-end funds, closed-end funds, and ETFs."
                },
                'U.S. Banks & Depositories': {
                    total: 4.5,
                    status: 'verified',
                    source: 'FDIC Banking Profile',
                    yoyChange: '-0.8%',
                    breakdown: {
                        'Large Commercial Banks (>$250B)': { amount: 2.8, status: 'estimated', change: '-0.5%', basis: 'FDIC' },
                        'Regional Banks ($10-250B)': { amount: 1.1, status: 'estimated', change: '-0.2%', basis: 'FDIC' },
                        'Community Banks (<$10B)': { amount: 0.4, status: 'estimated', change: '-0.1%', basis: 'FDIC' },
                        'Savings Institutions & Credit Unions': { amount: 0.2, status: 'estimated', change: '0.0%', basis: 'NCUA' }
                    },
                    sieNote: "Banks classify Treasuries as either Held-to-Maturity (HTM) at amortized cost or Available-for-Sale (AFS) at fair value. Under Basel III, Treasuries qualify as High-Quality Liquid Assets (HQLA) with 0% risk weighting. The 2023 regional bank crisis highlighted duration risk in HTM portfolios."
                },
                'Pension Funds': {
                    total: 2.5,
                    status: 'verified',
                    source: 'Fed Z.1 Report',
                    yoyChange: '+0.6%',
                    breakdown: {
                        'State & Local Government': { amount: 1.4, status: 'estimated', change: '+0.3%', basis: 'Census' },
                        'Corporate Defined Benefit': { amount: 0.7, status: 'estimated', change: '+0.2%', basis: 'DOL' },
                        'Corporate Defined Contribution': { amount: 0.4, status: 'estimated', change: '+0.1%', basis: 'DOL' }
                    },
                    sieNote: "ERISA establishes fiduciary standards for private pension plans. Defined Benefit plans use Liability-Driven Investing (LDI) with Treasuries for duration matching. 401(k) plans are Defined Contribution where investment risk shifts to participants."
                },
                'Insurance/State/Local/Other': {
                    total: 2.0,
                    status: 'verified',
                    source: 'Various Sources',
                    yoyChange: '+0.3%',
                    breakdown: {
                        'Life Insurance Companies': { amount: 0.9, status: 'estimated', change: '+0.2%', basis: 'NAIC' },
                        'Property & Casualty Insurers': { amount: 0.3, status: 'estimated', change: '0.0%', basis: 'NAIC' },
                        'State & Local Governments': { amount: 0.5, status: 'estimated', change: '+0.1%', basis: 'Census' },
                        'Other Institutional': { amount: 0.3, status: 'estimated', change: '0.0%', basis: 'Residual' }
                    },
                    sieNote: "Insurance companies use Asset-Liability Management (ALM) to match policy durations. Life insurers hold longer-duration Treasuries than P&C insurers. State regulations often mandate minimum Treasury allocations. General Account assets back guarantees; Separate Accounts shift risk to policyholders."
                }
            }
        };

        // Legacy data format for existing visualizations
        const data = {};
        const percentages = {};

        for (const [key, value] of Object.entries(treasuryHoldings.categories)) {
            data[key] = value.total;
            percentages[key] = (value.total / 36.0) * 100;
        }

        // Color scheme matching the site design
        const colors = {
            'Federal Reserve': '#002D62',  // Navy
            'Intragovernmental Holdings': '#4A6FA5',  // Lighter navy
            'Foreign Official Holders': '#B08D57',  // Gold
            'U.S. Mutual Funds & ETFs': '#2E7D32',  // Deep green
            'U.S. Banks & Depositories': '#43A047',  // Medium green
            'Pension Funds': '#66BB6A',  // Light green
            'Insurance/State/Local/Other': '#7C9885'  // Sage
        };

        // Enhanced table population with expandable rows
        function populateEnhancedTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = ''; // Clear existing content

            let footnoteCounter = 1;
            const sieNotes = [];

            // Sort categories by total amount
            const sortedCategories = Object.entries(treasuryHoldings.categories)
                .sort((a, b) => b[1].total - a[1].total);

            sortedCategories.forEach(([categoryName, categoryData]) => {
                const categoryId = categoryName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();

                // Create parent row
                const parentRow = tbody.insertRow();
                parentRow.className = 'parent-row';
                parentRow.dataset.category = categoryId;

                const statusBadge = categoryData.status === 'verified' ? 'ðŸŸ¢' : 'ðŸŸ¡';
                const changeClass = getChangeClass(categoryData.yoyChange);

                parentRow.innerHTML = `
                    <td class="expand-icon">â–¼</td>
                    <td class="holder-name">
                        ${categoryName}
                        <span class="status-badge">${statusBadge}</span>
                        <sup class="footnote-ref">[${footnoteCounter}]</sup>
                    </td>
                    <td class="amount">$${categoryData.total.toFixed(1)}T</td>
                    <td class="percentage">${((categoryData.total / 36.0) * 100).toFixed(1)}%</td>
                    <td class="source-note">${categoryData.source}</td>
                    <td class="change ${changeClass}">${categoryData.yoyChange}</td>
                `;

                // Store SIE note for later
                sieNotes.push({
                    number: footnoteCounter,
                    title: categoryName,
                    content: categoryData.sieNote
                });
                footnoteCounter++;

                // Create child rows
                if (categoryData.breakdown) {
                    Object.entries(categoryData.breakdown).forEach(([subName, subData]) => {
                        const childRow = tbody.insertRow();
                        childRow.className = 'child-row';
                        childRow.dataset.parent = categoryId;

                        const subStatusBadge = subData.status === 'verified' ? 'ðŸŸ¢' : 'ðŸŸ¡';
                        const subChangeClass = getChangeClass(subData.change);
                        const sourceText = subData.basis || 'Verified';

                        childRow.innerHTML = `
                            <td></td>
                            <td class="holder-name indented">
                                ${subName}
                                <span class="status-badge">${subStatusBadge}</span>
                            </td>
                            <td class="amount">$${subData.amount.toFixed(2)}T</td>
                            <td class="percentage">${((subData.amount / 36.0) * 100).toFixed(2)}%</td>
                            <td class="source-note">${sourceText}</td>
                            <td class="change ${subChangeClass}">${subData.change}</td>
                        `;
                    });
                }
            });

            // Add total row
            const totalRow = tbody.insertRow();
            totalRow.style.fontWeight = 'bold';
            totalRow.style.borderTop = '2px solid var(--fh-navy)';
            totalRow.innerHTML = `
                <td></td>
                <td>TOTAL U.S. TREASURY DEBT</td>
                <td class="amount">$36.0T</td>
                <td class="percentage">100.0%</td>
                <td colspan="2"></td>
            `;

            // Populate SIE notes
            populateSIENotes(sieNotes);
        }

        // Helper function to determine change class
        function getChangeClass(changeStr) {
            if (!changeStr) return 'neutral';
            if (changeStr.startsWith('+')) return 'positive';
            if (changeStr.startsWith('-')) return 'negative';
            return 'neutral';
        }

        // Populate SIE exam notes
        function populateSIENotes(notes) {
            const container = document.getElementById('sieNotesContainer');
            if (!container) return;

            container.innerHTML = notes.map(note => `
                <div class="sie-note">
                    <div class="sie-note-title">
                        <span>[${note.number}]</span>
                        ${note.title}
                    </div>
                    <div class="sie-note-content">
                        ${note.content}
                    </div>
                </div>
            `).join('');
        }

        // Setup table interactivity
        function setupTableInteractivity() {
            // Parent row click to expand/collapse
            document.querySelectorAll('.parent-row').forEach(row => {
                row.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const children = document.querySelectorAll(`[data-parent="${category}"]`);
                    const icon = this.querySelector('.expand-icon');

                    children.forEach(child => {
                        child.classList.toggle('hidden');
                    });

                    this.classList.toggle('expanded');
                    icon.textContent = icon.textContent === 'â–¼' ? 'â–¶' : 'â–¼';
                });
            });

            // Expand/Collapse All button
            const expandBtn = document.getElementById('expandAllBtn');
            if (expandBtn) {
                expandBtn.addEventListener('click', function() {
                    const isExpanding = this.textContent === 'Expand All';

                    document.querySelectorAll('.parent-row').forEach(row => {
                        const category = row.dataset.category;
                        const children = document.querySelectorAll(`[data-parent="${category}"]`);
                        const icon = row.querySelector('.expand-icon');

                        if (isExpanding) {
                            children.forEach(child => child.classList.remove('hidden'));
                            row.classList.add('expanded');
                            icon.textContent = 'â–¼';
                        } else {
                            children.forEach(child => child.classList.add('hidden'));
                            row.classList.remove('expanded');
                            icon.textContent = 'â–¶';
                        }
                    });

                    this.textContent = isExpanding ? 'Collapse All' : 'Expand All';
                });
            }
        }

        // 1. Pie Chart
        function createPieChart() {
            // Remove loading message immediately
            const container = document.getElementById('pieChart');
            if (container) {
                const loadingDiv = container.querySelector('.loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);

            const pieData = [{
                values: sortedData.map(d => d[1]),
                labels: sortedData.map(([k, v]) => `${k}<br>$${v.toFixed(1)}T`),
                type: 'pie',
                hole: 0,
                textposition: 'outside',
                textinfo: 'label+percent',
                marker: {
                    colors: sortedData.map(d => colors[d[0]] || '#999999'),
                    line: {
                        color: '#FFFFFF',
                        width: 2
                    }
                },
                pull: sortedData.map((_, i) => i < 3 ? 0.1 : 0),
                hovertemplate: '<b>%{label}</b><br>%{percent}<br>$%{value:.1f} Trillion<extra></extra>'
            }];

            const layout = {
                height: 600,
                font: {
                    family: 'Inter, -apple-system, sans-serif'
                },
                showlegend: false,
                margin: { l: 100, r: 100, t: 50, b: 50 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('pieChart', pieData, layout, {responsive: true});
        }

        // 2. Treemap
        function createTreemap() {
            // Remove loading message immediately
            const container = document.getElementById('treemapChart');
            if (container) {
                const loadingDiv = container.querySelector('.loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            const labels = Object.keys(data);
            const values = Object.values(data);
            // Create complete text with label, amount, and percentage all in one
            const text = labels.map(k => `${k}<br>$${data[k].toFixed(1)}T<br>${percentages[k].toFixed(1)}%`);

            const treemapData = [{
                type: 'treemap',
                labels: labels,
                parents: Array(labels.length).fill(""),
                values: values,
                text: text,
                textposition: 'middle center',
                textinfo: 'text',  // Only show the custom text, nothing else
                // Remove texttemplate completely to avoid duplication
                marker: {
                    colors: labels.map(l => colors[l] || '#999999'),
                    line: {
                        color: '#FFFFFF',
                        width: 2
                    }
                },
                hovertemplate: '<b>%{label}</b><br>Value: $%{value:.1f} Trillion<br>Share: %{percentroot}<extra></extra>',
                textfont: {
                    family: 'Inter, -apple-system, sans-serif',
                    size: 14
                }
            }];

            const layout = {
                height: 500,
                margin: { l: 0, r: 0, t: 0, b: 0 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('treemapChart', treemapData, layout, {responsive: true});
        }

        // 3. Enhanced Sankey Diagram with subcategories
        function createSankey() {
            // Remove loading message immediately
            const container = document.getElementById('sankeyChart');
            if (container) {
                const loadingDiv = container.querySelector('.loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            // Build nodes array with subcategories
            const nodes = [];
            const nodeColors = [];
            const links = [];

            // Main source node
            nodes.push("U.S. Treasury Debt<br>$36T");
            nodeColors.push('#808080');

            // Category groupings
            nodes.push("U.S. Government<br>$13.3T (36.9%)");  // 1
            nodes.push("Domestic Private<br>$14.2T (39.4%)");  // 2
            nodes.push("Foreign Holders<br>$8.5T (23.6%)");   // 3
            nodeColors.push('#002D62', '#2E7D32', '#B08D57');

            let nodeIndex = 4;
            const categoryIndices = {};

            // Add main categories and their subcategories
            const govCategories = ['Federal Reserve', 'Intragovernmental Holdings'];
            const domesticCategories = ['U.S. Mutual Funds & ETFs', 'U.S. Banks & Depositories',
                                      'Pension Funds', 'Insurance/State/Local/Other'];

            // Government categories
            govCategories.forEach(cat => {
                const catData = treasuryHoldings.categories[cat];
                nodes.push(`${cat}<br>$${catData.total.toFixed(1)}T`);
                nodeColors.push('#002D62');
                categoryIndices[cat] = nodeIndex++;
                links.push({
                    source: 1,
                    target: categoryIndices[cat],
                    value: catData.total
                });
            });

            // Domestic categories
            domesticCategories.forEach(cat => {
                const catData = treasuryHoldings.categories[cat];
                nodes.push(`${cat}<br>$${catData.total.toFixed(1)}T`);
                nodeColors.push('#2E7D32');
                categoryIndices[cat] = nodeIndex++;
                links.push({
                    source: 2,
                    target: categoryIndices[cat],
                    value: catData.total
                });
            });

            // Foreign category
            const foreignData = treasuryHoldings.categories['Foreign Official Holders'];
            nodes.push(`Foreign Official Holders<br>$${foreignData.total.toFixed(1)}T`);
            nodeColors.push('#B08D57');
            categoryIndices['Foreign Official Holders'] = nodeIndex++;
            links.push({
                source: 3,
                target: categoryIndices['Foreign Official Holders'],
                value: foreignData.total
            });

            // Removed individual country nodes to prevent duplication and maintain consistency

            // Main flow links
            links.unshift(
                { source: 0, target: 1, value: 13.3 },
                { source: 0, target: 2, value: 14.2 },
                { source: 0, target: 3, value: 8.5 }
            );

            const sankeyData = {
                type: "sankey",
                orientation: "h",
                node: {
                    pad: 15,
                    thickness: 25,
                    line: {
                        color: "white",
                        width: 1
                    },
                    label: nodes,
                    color: nodeColors,
                    hovertemplate: '%{label}<extra></extra>'
                },
                link: {
                    source: links.map(l => l.source),
                    target: links.map(l => l.target),
                    value: links.map(l => l.value),
                    color: 'rgba(0,0,0,0.15)',
                    hovertemplate: '$%{value:.2f} Trillion<extra></extra>'
                }
            };

            const layout = {
                height: 600,
                font: {
                    family: 'Inter, -apple-system, sans-serif',
                    size: 12
                },
                margin: { l: 10, r: 10, t: 10, b: 10 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('sankeyChart', [sankeyData], layout, {responsive: true});
        }

        // Initialize all visualizations
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. Checking for Plotly...');

            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error('Plotly is not defined! CDN may be blocked or failed to load.');
                document.querySelectorAll('.loading').forEach(el => {
                    el.innerHTML = '<span style="color: red;">Error: Plotly.js library failed to load. This may be due to:<br>â€¢ Network/firewall blocking CDN<br>â€¢ Ad blocker interference<br>â€¢ Browser security settings<br>Please check console for details.</span>';
                });
                return;
            }

            console.log('Plotly loaded successfully:', typeof Plotly);

            try {
                populateEnhancedTable();
                setupTableInteractivity();
            } catch (error) {
                // Silently handle error in production
                console.error('Table initialization error:', error);
            }

            // Create visualizations with proper loading message removal
            setTimeout(() => {
                const pieContainer = document.getElementById('pieChart');
                try {
                    console.log('Creating pie chart...');
                    createPieChart();
                    console.log('Pie chart created successfully');
                } catch (error) {
                    console.error('Pie Chart Error:', error);
                    if (pieContainer) {
                        pieContainer.innerHTML = '<div style="color: red;">Error loading pie chart: ' + error.message + '</div>';
                    }
                }
            }, 100);

            setTimeout(() => {
                const treemapContainer = document.getElementById('treemapChart');
                try {
                    console.log('Creating treemap...');
                    createTreemap();
                    console.log('Treemap created successfully');
                } catch (error) {
                    console.error('Treemap Error:', error);
                    if (treemapContainer) {
                        treemapContainer.innerHTML = '<div style="color: red;">Error loading treemap: ' + error.message + '</div>';
                    }
                }
            }, 200);

            setTimeout(() => {
                const sankeyContainer = document.getElementById('sankeyChart');
                try {
                    console.log('Creating sankey diagram...');
                    createSankey();
                    console.log('Sankey diagram created successfully');
                } catch (error) {
                    console.error('Sankey Error:', error);
                    if (sankeyContainer) {
                        sankeyContainer.innerHTML = '<div style="color: red;">Error loading flow diagram: ' + error.message + '</div>';
                    }
                }
            }, 300);

            // Aggressive failsafe: Remove ALL loading messages after charts should be loaded
            setTimeout(() => {
                document.querySelectorAll('.loading').forEach(el => {
                    console.warn('Removing loading message from:', el.parentElement?.id || 'unknown');
                    el.remove();  // Completely remove the element, not just hide it
                });
            }, 500);
        });

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>
