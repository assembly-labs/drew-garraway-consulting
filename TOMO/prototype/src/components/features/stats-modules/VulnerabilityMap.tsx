/**
 * Vulnerability Map - Blue Belt Stats Module
 *
 * Shows where the user is getting caught (submissions received).
 * Analyzes by technique and body region, provides defense suggestions.
 *
 * Design: Body region breakdown with top vulnerabilities
 * Data: submissionsReceived[] (reliable)
 */

import { useMemo } from 'react';
import { Icons } from '../../ui/Icons';
import {
  calculateBodyRegionBreakdown,
  getTopTechniques,
  DEFENSE_SUGGESTIONS,
  MODULE_COPY,
  type SubmissionRecord,
} from '../../../data/stats-modules';

interface VulnerabilityMapProps {
  submissionsReceived: SubmissionRecord[];
  variant?: 'full' | 'compact';
}

export function VulnerabilityMap({
  submissionsReceived,
  variant = 'full',
}: VulnerabilityMapProps) {
  // Calculate body region breakdown
  const bodyBreakdown = useMemo(
    () => calculateBodyRegionBreakdown(submissionsReceived),
    [submissionsReceived]
  );

  const totalReceived = submissionsReceived.length;

  // Find most vulnerable region
  const mostVulnerable = useMemo(() => {
    if (totalReceived === 0) return null;

    const regions: Array<{ region: 'neck' | 'arms' | 'legs'; count: number }> = [
      { region: 'neck', count: bodyBreakdown.neck },
      { region: 'arms', count: bodyBreakdown.arms },
      { region: 'legs', count: bodyBreakdown.legs },
    ];

    return regions.sort((a, b) => b.count - a.count)[0];
  }, [bodyBreakdown, totalReceived]);

  // Get defense suggestions for most vulnerable region
  const defenseSuggestions = useMemo(() => {
    if (!mostVulnerable || mostVulnerable.count === 0) return null;
    return DEFENSE_SUGGESTIONS.find((s) => s.region === mostVulnerable.region);
  }, [mostVulnerable]);

  // Get top techniques catching user
  const topVulnerabilities = useMemo(
    () => getTopTechniques(submissionsReceived, 5),
    [submissionsReceived]
  );

  const copy = MODULE_COPY.find((c) => c.moduleId === 'vulnerability-map');

  // Empty state
  if (totalReceived === 0) {
    return (
      <section style={styles.container}>
        <div style={styles.header}>
          <div style={styles.headerIcon}>
            <Icons.AlertCircle size={20} color="var(--color-negative)" />
          </div>
          <span style={styles.headerLabel}>VULNERABILITIES</span>
        </div>
        <div style={styles.emptyState}>
          <Icons.Shield size={32} color="var(--color-gray-600)" />
          <p style={styles.emptyText}>
            {copy?.emptyState || 'Track submissions to identify your vulnerabilities.'}
          </p>
        </div>
      </section>
    );
  }

  if (variant === 'compact') {
    return (
      <CompactVulnerabilityMap
        bodyBreakdown={bodyBreakdown}
        totalReceived={totalReceived}
        topVulnerability={topVulnerabilities[0]}
        mostVulnerable={mostVulnerable}
      />
    );
  }

  return (
    <section style={styles.container}>
      {/* Section Header */}
      <div style={styles.header}>
        <div style={styles.headerLeft}>
          <div style={styles.headerIcon}>
            <Icons.AlertCircle size={20} color="var(--color-negative)" />
          </div>
          <span style={styles.headerLabel}>WHERE YOU GET CAUGHT</span>
        </div>
        <div style={styles.headerRight}>
          <span style={styles.headerCount}>{totalReceived} taps</span>
        </div>
      </div>

      {/* Body Region Breakdown - Horizontal Bars */}
      <div style={styles.bodySection}>
        <span style={styles.sectionTitle}>ATTACK ZONES</span>
        <div style={styles.regionBars}>
          {/* Neck */}
          <div style={styles.regionRow}>
            <div style={styles.regionLabel}>
              <span style={styles.regionName}>Neck</span>
              <span style={styles.regionCount}>
                {bodyBreakdown.neck} ({Math.round((bodyBreakdown.neck / totalReceived) * 100)}%)
              </span>
            </div>
            <div style={styles.barContainer}>
              <div
                style={{
                  ...styles.barFill,
                  width: `${(bodyBreakdown.neck / totalReceived) * 100}%`,
                  background:
                    mostVulnerable?.region === 'neck'
                      ? 'var(--color-negative)'
                      : 'var(--color-gray-500)',
                }}
              />
            </div>
          </div>

          {/* Arms */}
          <div style={styles.regionRow}>
            <div style={styles.regionLabel}>
              <span style={styles.regionName}>Arms</span>
              <span style={styles.regionCount}>
                {bodyBreakdown.arms} ({Math.round((bodyBreakdown.arms / totalReceived) * 100)}%)
              </span>
            </div>
            <div style={styles.barContainer}>
              <div
                style={{
                  ...styles.barFill,
                  width: `${(bodyBreakdown.arms / totalReceived) * 100}%`,
                  background:
                    mostVulnerable?.region === 'arms'
                      ? 'var(--color-negative)'
                      : 'var(--color-gray-500)',
                }}
              />
            </div>
          </div>

          {/* Legs */}
          <div style={styles.regionRow}>
            <div style={styles.regionLabel}>
              <span style={styles.regionName}>Legs</span>
              <span style={styles.regionCount}>
                {bodyBreakdown.legs} ({Math.round((bodyBreakdown.legs / totalReceived) * 100)}%)
              </span>
            </div>
            <div style={styles.barContainer}>
              <div
                style={{
                  ...styles.barFill,
                  width: `${(bodyBreakdown.legs / totalReceived) * 100}%`,
                  background:
                    mostVulnerable?.region === 'legs'
                      ? 'var(--color-negative)'
                      : 'var(--color-gray-500)',
                }}
              />
            </div>
          </div>
        </div>
      </div>

      {/* Top Techniques Catching You */}
      {topVulnerabilities.length > 0 && (
        <div style={styles.vulnerabilitiesSection}>
          <span style={styles.sectionTitle}>WHAT CATCHES YOU</span>
          <div style={styles.vulnerabilityList}>
            {topVulnerabilities.map((vuln, index) => (
              <div key={vuln.technique} style={styles.vulnerabilityRow}>
                <span style={styles.vulnerabilityRank}>{index + 1}.</span>
                <span style={styles.vulnerabilityName}>{vuln.technique}</span>
                <div style={styles.vulnerabilityBarContainer}>
                  <div
                    style={{
                      ...styles.vulnerabilityBarFill,
                      width: `${(vuln.count / topVulnerabilities[0].count) * 100}%`,
                    }}
                  />
                </div>
                <span style={styles.vulnerabilityCount}>{vuln.count}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Defense Suggestions */}
      {defenseSuggestions && (
        <div style={styles.suggestionsSection}>
          <div style={styles.suggestionsHeader}>
            <Icons.Shield size={16} color="var(--color-gold)" />
            <span style={styles.suggestionsTitle}>{defenseSuggestions.title}</span>
          </div>
          <ul style={styles.suggestionsList}>
            {defenseSuggestions.suggestions.map((suggestion, index) => (
              <li key={index} style={styles.suggestionItem}>
                <Icons.ChevronRight size={12} color="var(--color-gray-500)" />
                <span style={styles.suggestionText}>{suggestion}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Insight */}
      <div style={styles.insightBox}>
        <p style={styles.insight}>
          {copy?.insights[Math.floor(Math.random() * copy.insights.length)] ||
            'Every tap is a lesson.'}
        </p>
      </div>
    </section>
  );
}

// Compact variant
function CompactVulnerabilityMap({
  bodyBreakdown,
  totalReceived,
  topVulnerability,
  mostVulnerable,
}: {
  bodyBreakdown: Record<'neck' | 'arms' | 'legs', number>;
  totalReceived: number;
  topVulnerability: { technique: string; count: number } | undefined;
  mostVulnerable: { region: 'neck' | 'arms' | 'legs'; count: number } | null;
}) {
  return (
    <div style={styles.compactContainer}>
      <div style={styles.compactHeader}>
        <Icons.AlertCircle size={16} color="var(--color-negative)" />
        <span style={styles.compactLabel}>VULNERABILITIES</span>
        <span style={styles.compactCount}>{totalReceived} taps</span>
      </div>

      <div style={styles.compactContent}>
        {/* Most Vulnerable Region */}
        {mostVulnerable && mostVulnerable.count > 0 && (
          <div style={styles.compactPrimary}>
            <span style={styles.compactRegionLabel}>
              Most caught: <strong>{mostVulnerable.region.toUpperCase()}</strong>
            </span>
            <span style={styles.compactRegionPercent}>
              {Math.round((mostVulnerable.count / totalReceived) * 100)}%
            </span>
          </div>
        )}

        {/* Top Technique */}
        {topVulnerability && (
          <div style={styles.compactSecondary}>
            <span style={styles.compactTechnique}>
              Top: {topVulnerability.technique} ({topVulnerability.count})
            </span>
          </div>
        )}

        {/* Mini Region Bars */}
        <div style={styles.compactBars}>
          <div style={styles.compactBarGroup}>
            <span style={styles.compactBarLabel}>N</span>
            <div style={styles.compactBarBg}>
              <div
                style={{
                  ...styles.compactBarFill,
                  width: `${totalReceived > 0 ? (bodyBreakdown.neck / totalReceived) * 100 : 0}%`,
                }}
              />
            </div>
          </div>
          <div style={styles.compactBarGroup}>
            <span style={styles.compactBarLabel}>A</span>
            <div style={styles.compactBarBg}>
              <div
                style={{
                  ...styles.compactBarFill,
                  width: `${totalReceived > 0 ? (bodyBreakdown.arms / totalReceived) * 100 : 0}%`,
                }}
              />
            </div>
          </div>
          <div style={styles.compactBarGroup}>
            <span style={styles.compactBarLabel}>L</span>
            <div style={styles.compactBarBg}>
              <div
                style={{
                  ...styles.compactBarFill,
                  width: `${totalReceived > 0 ? (bodyBreakdown.legs / totalReceived) * 100 : 0}%`,
                }}
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

const styles: Record<string, React.CSSProperties> = {
  container: {
    background: 'var(--color-gray-800)',
    padding: 'var(--space-lg)',
    marginBottom: '1px',
  },
  header: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 'var(--space-lg)',
  },
  headerLeft: {
    display: 'flex',
    alignItems: 'center',
    gap: 'var(--space-sm)',
  },
  headerIcon: {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
  },
  headerLabel: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 600,
    letterSpacing: 'var(--tracking-widest)',
    color: 'var(--color-gray-400)',
    textTransform: 'uppercase' as const,
  },
  headerRight: {},
  headerCount: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-sm)',
    fontWeight: 700,
    color: 'var(--color-negative)',
  },
  emptyState: {
    display: 'flex',
    flexDirection: 'column' as const,
    alignItems: 'center',
    gap: 'var(--space-md)',
    padding: 'var(--space-xl)',
  },
  emptyText: {
    fontFamily: 'var(--font-body)',
    fontSize: 'var(--text-sm)',
    fontWeight: 500,
    color: 'var(--color-gray-500)',
    textAlign: 'center' as const,
    margin: 0,
  },
  bodySection: {
    marginBottom: 'var(--space-lg)',
  },
  sectionTitle: {
    display: 'block',
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 600,
    letterSpacing: 'var(--tracking-wider)',
    color: 'var(--color-gray-500)',
    marginBottom: 'var(--space-md)',
  },
  regionBars: {
    display: 'flex',
    flexDirection: 'column' as const,
    gap: 'var(--space-sm)',
  },
  regionRow: {
    display: 'flex',
    flexDirection: 'column' as const,
    gap: '4px',
  },
  regionLabel: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  regionName: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 600,
    color: 'var(--color-gray-400)',
    textTransform: 'uppercase' as const,
  },
  regionCount: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 500,
    color: 'var(--color-gray-500)',
  },
  barContainer: {
    height: '12px',
    background: 'var(--color-gray-700)',
    borderRadius: '2px',
    overflow: 'hidden',
  },
  barFill: {
    height: '100%',
    borderRadius: '2px',
    transition: 'width 0.5s ease',
  },
  vulnerabilitiesSection: {
    marginBottom: 'var(--space-lg)',
  },
  vulnerabilityList: {
    display: 'flex',
    flexDirection: 'column' as const,
    gap: 'var(--space-sm)',
  },
  vulnerabilityRow: {
    display: 'flex',
    alignItems: 'center',
    gap: 'var(--space-sm)',
    padding: 'var(--space-sm)',
    background: 'var(--color-gray-900)',
  },
  vulnerabilityRank: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-sm)',
    fontWeight: 700,
    color: 'var(--color-negative)',
    width: '20px',
  },
  vulnerabilityName: {
    fontFamily: 'var(--font-body)',
    fontSize: 'var(--text-sm)',
    fontWeight: 600,
    color: 'var(--color-white)',
    width: '100px',
  },
  vulnerabilityBarContainer: {
    flex: 1,
    height: '8px',
    background: 'var(--color-gray-700)',
    borderRadius: '2px',
    overflow: 'hidden',
  },
  vulnerabilityBarFill: {
    height: '100%',
    background: 'var(--color-negative)',
    borderRadius: '2px',
    opacity: 0.7,
  },
  vulnerabilityCount: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-sm)',
    fontWeight: 700,
    color: 'var(--color-gray-400)',
    width: '24px',
    textAlign: 'right' as const,
  },
  suggestionsSection: {
    marginBottom: 'var(--space-lg)',
    padding: 'var(--space-md)',
    background: 'var(--color-gold-dim)',
    borderLeft: '3px solid var(--color-gold)',
  },
  suggestionsHeader: {
    display: 'flex',
    alignItems: 'center',
    gap: 'var(--space-sm)',
    marginBottom: 'var(--space-md)',
  },
  suggestionsTitle: {
    fontFamily: 'var(--font-heading)',
    fontSize: 'var(--text-sm)',
    fontWeight: 700,
    color: 'var(--color-gold)',
  },
  suggestionsList: {
    margin: 0,
    padding: 0,
    listStyle: 'none',
    display: 'flex',
    flexDirection: 'column' as const,
    gap: 'var(--space-sm)',
  },
  suggestionItem: {
    display: 'flex',
    alignItems: 'flex-start',
    gap: 'var(--space-sm)',
  },
  suggestionText: {
    fontFamily: 'var(--font-body)',
    fontSize: 'var(--text-sm)',
    fontWeight: 500,
    color: 'var(--color-gray-300)',
    lineHeight: 'var(--leading-normal)',
  },
  insightBox: {
    padding: 'var(--space-md)',
    background: 'var(--color-gray-900)',
    borderLeft: '3px solid var(--color-gray-600)',
  },
  insight: {
    fontFamily: 'var(--font-body)',
    fontSize: 'var(--text-sm)',
    fontWeight: 500,
    fontStyle: 'italic',
    color: 'var(--color-gray-400)',
    margin: 0,
    lineHeight: 'var(--leading-normal)',
  },
  // Compact styles
  compactContainer: {
    background: 'var(--color-gray-800)',
    padding: 'var(--space-md)',
  },
  compactHeader: {
    display: 'flex',
    alignItems: 'center',
    gap: 'var(--space-xs)',
    marginBottom: 'var(--space-sm)',
  },
  compactLabel: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 600,
    letterSpacing: 'var(--tracking-wider)',
    color: 'var(--color-gray-500)',
    flex: 1,
  },
  compactCount: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 700,
    color: 'var(--color-negative)',
  },
  compactContent: {
    display: 'flex',
    flexDirection: 'column' as const,
    gap: 'var(--space-sm)',
  },
  compactPrimary: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  compactRegionLabel: {
    fontFamily: 'var(--font-body)',
    fontSize: 'var(--text-sm)',
    fontWeight: 500,
    color: 'var(--color-gray-400)',
  },
  compactRegionPercent: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-sm)',
    fontWeight: 700,
    color: 'var(--color-negative)',
  },
  compactSecondary: {},
  compactTechnique: {
    fontFamily: 'var(--font-mono)',
    fontSize: 'var(--text-xs)',
    fontWeight: 500,
    color: 'var(--color-gray-500)',
  },
  compactBars: {
    display: 'flex',
    gap: 'var(--space-md)',
    marginTop: 'var(--space-xs)',
  },
  compactBarGroup: {
    display: 'flex',
    alignItems: 'center',
    gap: '4px',
    flex: 1,
  },
  compactBarLabel: {
    fontFamily: 'var(--font-mono)',
    fontSize: '10px',
    fontWeight: 600,
    color: 'var(--color-gray-600)',
    width: '12px',
  },
  compactBarBg: {
    flex: 1,
    height: '4px',
    background: 'var(--color-gray-700)',
    borderRadius: '2px',
    overflow: 'hidden',
  },
  compactBarFill: {
    height: '100%',
    background: 'var(--color-negative)',
    opacity: 0.7,
  },
};
