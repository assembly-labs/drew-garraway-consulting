<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kicking Myself â€” Investment Time Machine</title>

  <!-- Fonts: system stack per spec -->
  <style>
    :root {
      /* 4.1 Color Palette */
      --bg-primary: #0A0E1A;          /* dark navy */
      --bg-secondary: #212121;        /* dark gray */
      --text-primary: #FFFFFF;        /* white */
      --text-secondary: #B0B0B0;      /* light gray */
      --accent-green: #00E676;        /* neon green */
      --accent-purple: #9C27B0;       /* vibrant purple */
      --danger: #F44336;              /* red */
      --shadow: 0 10px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);

      --radius-card: 16px;
      --radius-button: 10px;
      --gap: 16px;
      --gap-lg: 24px;
      --grid-max: 1200px;

      /* Typography scale (rem-based) */
      --fs-h1: 3rem;   /* 48px */
      --fs-h2: 1.5rem; /* 24px */
      --fs-body: 1rem; /* 16px */
      --fs-label: 0.875rem; /* 14px */
    }

    /* Global / base */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(156,39,176,0.25), transparent 60%),
                  radial-gradient(1000px 500px at 120% 10%, rgba(0,230,118,0.2), transparent 60%),
                  linear-gradient(to bottom, #0A0E1A, #1A0F2B 60%, #0A0E1A);
    }
    body {
      margin: 0;
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: var(--fs-body);
      line-height: 1.5;
    }
    a { color: var(--accent-green); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Layout */
    .container {
      max-width: var(--grid-max);
      margin: 0 auto;
      padding: 24px;
    }

    /* Header with pulsing gradient */
    header {
      margin-bottom: 24px;
      padding: 24px;
      border-radius: var(--radius-card);
      background:
        linear-gradient(135deg, rgba(156,39,176,0.25), rgba(0,230,118,0.2));
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    header::after {
      content: "";
      position: absolute;
      inset: -20%;
      background: radial-gradient(60% 60% at 50% 50%, rgba(156,39,176,0.2), transparent 60%);
      animation: pulse 6s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.05); opacity: 1; }
    }
    .title {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .title h1 {
      margin: 0;
      font-size: var(--fs-h1);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .title p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    /* Input Section */
    .panel {
      background: rgba(33,33,33,0.85);
      backdrop-filter: blur(6px);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--gap);
    }
    @media (max-width: 900px) {
      .inputs-grid { grid-template-columns: 1fr; }
    }
    label {
      display: block;
      font-size: var(--fs-label);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .input-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #11151f;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 12px 14px;
      outline: none;
      color: var(--text-primary);
      width: 100%;
    }
    .field:focus-within {
      border-color: rgba(156,39,176,0.7);
      box-shadow: 0 0 0 3px rgba(156,39,176,0.15);
    }
    .prefix {
      color: var(--text-secondary);
      font-weight: 700;
      user-select: none;
    }
    input, select {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 1rem;
      width: 100%;
      appearance: none;
    }
    select option {
      color: #000; /* native dropdown list */
    }

    /* Buttons */
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }
    .btn {
      border: none;
      border-radius: var(--radius-button);
      padding: 12px 20px;
      font-weight: 800;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      box-shadow: var(--shadow);
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-green), #22ffa1);
      color: #052b16;
    }
    .btn-secondary {
      background: #2a2a2a;
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .btn:hover { transform: translateY(-2px) scale(1.02); }

    /* Error + Loading */
    .error {
      display: none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(244,67,54,0.1);
      border: 1px solid rgba(244,67,54,0.45);
      color: #ffbdb7;
      font-weight: 600;
      animation: none;
    }
    .error.show {
      display: block;
      animation: shake 0.4s ease;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-3px); }
    }

    .loading {
      display: none;
      margin-top: 12px;
      gap: 10px;
      align-items: center;
      color: var(--text-secondary);
    }
    .loading.show { display: inline-flex; }
    .spinner {
      width: 18px; height: 18px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent-purple);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Results Section */
    .results {
      margin-top: 24px;
      display: none;
      animation: slideUp 0.35s ease both;
    }
    .results.show { display: block; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--gap);
    }
    @media (max-width: 1000px) {
      .metrics-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .metrics-grid { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--bg-secondary);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h3 {
      margin: 0 0 6px;
      color: var(--text-secondary);
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .metric-value {
      font-size: 1.4rem;
      font-weight: 800;
    }
    .pos { color: var(--accent-green); }
    .neg { color: var(--danger); }

    /* Chart section */
    .chart-panel {
      margin-top: var(--gap-lg);
    }
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .chart-header h2 {
      margin: 0;
      font-size: var(--fs-h2);
      font-weight: 800;
      letter-spacing: 0.02em;
    }
    .toggle {
      display: inline-flex;
      background: #171a24;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
    }
    .toggle button {
      background: transparent;
      color: var(--text-secondary);
      padding: 8px 14px;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }
    .toggle button.active {
      background: var(--accent-purple);
      color: #fff;
    }
    .chart-wrap {
      background: var(--bg-secondary);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    canvas { width: 100%; max-height: 420px; }

    /* Insights */
    .insights {
      margin-top: var(--gap-lg);
      background: linear-gradient(135deg, rgba(255,234,0,0.13), rgba(255,214,10,0.14));
      border: 1px solid rgba(255,234,0,0.25);
      color: #fff7c2;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .insights h3 {
      margin: 0 0 8px;
      color: #fff7c2;
      letter-spacing: 0.03em;
    }
    .quote {
      margin: 10px 0 14px;
      padding: 10px 12px;
      border-left: 4px solid #ffe25b;
      background: rgba(0,0,0,0.15);
      font-style: italic;
      color: #fff6b2;
    }
    .insights ul {
      margin: 0;
      padding-left: 18px;
    }
    .insights li { margin: 6px 0; }

    /* Disclaimer */
    .disclaimer {
      margin-top: var(--gap-lg);
      font-size: 0.9rem;
      color: var(--text-secondary);
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px 14px;
    }

    /* Visually hidden for ARIA live regions */
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }
  </style>

  <!-- Chart.js & date-fns (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js" defer></script>
</head>
<body>
  <div class="container">
    <header aria-labelledby="app-title">
      <div class="title">
        <h1 id="app-title">Kicking Myself</h1>
        <p>The Investment Time Machine That Hurts</p>
      </div>
    </header>

    <!-- Input Panel -->
    <section class="panel" aria-labelledby="inputs-heading">
      <h2 id="inputs-heading" class="sr-only">Investment Inputs</h2>
      <div class="inputs-grid" role="group" aria-describedby="inputs-help">
        <!-- Date -->
        <div class="input-wrap">
          <label for="date">Investment Date (Month)</label>
          <div class="field">
            <input id="date" type="month" aria-describedby="date-help" />
          </div>
          <small id="date-help" style="color:var(--text-secondary)">Range: 2010-01 to last month.</small>
        </div>

        <!-- Amount -->
        <div class="input-wrap">
          <label for="amount">Investment Amount (USD)</label>
          <div class="field">
            <span class="prefix" aria-hidden="true">$</span>
            <input id="amount" type="number" min="1" max="10000000" step="100" value="10000" inputmode="decimal" aria-describedby="amount-help" />
          </div>
          <small id="amount-help" style="color:var(--text-secondary)">Min $1, Max $10,000,000.</small>
        </div>

        <!-- Asset -->
        <div class="input-wrap">
          <label for="asset">Asset</label>
          <div class="field">
            <select id="asset" aria-describedby="asset-help">
              <optgroup label="Cryptocurrency">
                <option value="X:BTCUSD">BTC (X:BTCUSD)</option>
                <option value="X:ETHUSD">ETH (X:ETHUSD)</option>
              </optgroup>
              <optgroup label="Tech Giants">
                <option value="AAPL">AAPL (Apple)</option>
                <option value="GOOGL">GOOGL (Alphabet)</option>
                <option value="AMZN">AMZN (Amazon)</option>
                <option value="MSFT">MSFT (Microsoft)</option>
                <option value="NVDA">NVDA (NVIDIA)</option>
                <option value="TSLA">TSLA (Tesla)</option>
                <option value="META">META (Meta)</option>
              </optgroup>
              <optgroup label="Index Funds">
                <option value="SPY">SPY (S&P 500)</option>
                <option value="QQQ">QQQ (Nasdaq-100)</option>
              </optgroup>
            </select>
          </div>
          <small id="asset-help" style="color:var(--text-secondary)">Predefined list only (demo).</small>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions" aria-label="Actions">
        <button id="calc" class="btn btn-primary">Calculate My Regret ðŸ“‰</button>
        <button id="reset" class="btn btn-secondary" type="button">Reset</button>
        <span id="loading" class="loading" role="status" aria-live="polite" aria-busy="false">
          <span class="spinner" aria-hidden="true"></span>
          <span>Calculating your missed opportunityâ€¦</span>
        </span>
      </div>

      <!-- Error Banner -->
      <div id="error" class="error" role="alert" aria-live="assertive"></div>
      <div id="inputs-help" class="sr-only">Choose a past month, an amount, and an asset, then press Calculate.</div>
    </section>

    <!-- Results -->
    <section id="results" class="results" aria-labelledby="results-heading" aria-live="polite">
      <h2 id="results-heading" class="sr-only">Results</h2>

      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <div class="card">
          <h3>Initial Investment</h3>
          <div id="m-initial" class="metric-value">$â€”</div>
          <div id="m-initial-date" style="color:var(--text-secondary); font-size:0.9rem;">â€”</div>
        </div>
        <div class="card">
          <h3>Current Value</h3>
          <div id="m-current" class="metric-value">$â€”</div>
          <div id="m-asof" style="color:var(--text-secondary); font-size:0.9rem;">â€”</div>
        </div>
        <div class="card">
          <h3>Total Gain / Loss</h3>
          <div id="m-gain" class="metric-value">â€”</div>
          <div id="m-gain-pct" style="font-weight:700;">â€”</div>
        </div>
        <div class="card">
          <h3>Annualized Return (CAGR)</h3>
          <div id="m-cagr" class="metric-value">â€”</div>
          <div style="color:var(--text-secondary); font-size:0.9rem;">approx.</div>
        </div>
        <div class="card">
          <h3>Best Day (Peak)</h3>
          <div id="m-peak" class="metric-value">$â€”</div>
          <div id="m-peak-date" style="color:var(--text-secondary); font-size:0.9rem;">â€”</div>
        </div>
        <div class="card">
          <h3>Worst Drawdown</h3>
          <div id="m-dd" class="metric-value neg">â€”</div>
          <div id="m-dd-period" style="color:var(--text-secondary); font-size:0.9rem;">â€”</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-panel">
        <div class="chart-header">
          <h2>Investment Performance Over Time</h2>
          <div class="toggle" role="tablist" aria-label="Y Scale">
            <button id="scale-linear" class="active" role="tab" aria-selected="true">Line</button>
            <button id="scale-log" role="tab" aria-selected="false">Log Scale</button>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="chart" height="400" aria-label="Portfolio value chart" role="img"></canvas>
        </div>
      </div>

      <!-- Insights -->
      <div class="insights">
        <h3>Insights</h3>
        <div id="insight-quote" class="quote">â€”</div>
        <ul id="insight-list"></ul>
      </div>

      <!-- Disclaimer -->
      <div class="disclaimer">
        Educational demo. Not financial advice. Data from Polygon.io and may reflect adjustments/splits. Results are illustrative, past performance â‰  future results.
      </div>
    </section>
  </div>

  <script>
    // ========== Config ==========
    const POLY_API_KEY = "z37IuRmsdR5bzP6L1Eg_u3SCSeW2vUaM";
    const POLY_ENDPOINT = "https://api.polygon.io/v2/aggs/ticker";
    const MAX_AMOUNT = 10_000_000;

    const ASSET_NAMES = {
      "X:BTCUSD": "Bitcoin",
      "X:ETHUSD": "Ethereum",
      "AAPL": "Apple",
      "GOOGL": "Alphabet (Google)",
      "AMZN": "Amazon",
      "MSFT": "Microsoft",
      "NVDA": "NVIDIA",
      "TSLA": "Tesla",
      "META": "Meta",
      "SPY": "S&P 500 (SPY)",
      "QQQ": "Nasdaq-100 (QQQ)",
    };

    // ========== Helpers ==========
    const $ = (sel) => document.querySelector(sel);

    function clamp(n, min, max) { return Math.min(Math.max(n, min), max); }

    function toISODate(d) {
      return new Date(d.getTime() - (d.getTimezoneOffset() * 60000))
             .toISOString().slice(0,10);
    }

    function formatUSD(n) {
      if (!isFinite(n)) return "$â€”";
      const abs = Math.abs(n);
      if (abs >= 1_000_000_000) return (n/1_000_000_000).toLocaleString(undefined, { maximumFractionDigits: 2 }) + "B";
      if (abs >= 1_000_000)     return (n/1_000_000).toLocaleString(undefined, { maximumFractionDigits: 2 }) + "M";
      if (abs >= 1_000)         return (n/1_000).toLocaleString(undefined, { maximumFractionDigits: 2 }) + "K";
      return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }

    function formatUSDFull(n) {
      return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }

    function fmtPct(x) {
      const sign = x >= 0 ? "+" : "";
      return `${sign}${x.toFixed(2)}%`;
    }

    function monthFirstDayStr(yyyyMm) {
      const [y, m] = yyyyMm.split("-").map(Number);
      return `${y}-${String(m).padStart(2,"0")}-01`;
    }

    function yearsBetween(d1, d2) {
      const ms = Math.max(0, d2 - d1);
      return ms / (365.25 * 24 * 3600 * 1000);
    }

    function setButtonActive(btnOn, btnOff) {
      btnOn.classList.add("active");
      btnOn.setAttribute("aria-selected", "true");
      btnOff.classList.remove("active");
      btnOff.setAttribute("aria-selected", "false");
    }

    // ========== DOM refs ==========
    const dateEl   = $("#date");
    const amtEl    = $("#amount");
    const assetEl  = $("#asset");
    const calcBtn  = $("#calc");
    const resetBtn = $("#reset");
    const errorBox = $("#error");
    const loading  = $("#loading");
    const results  = $("#results");
    const mInitial = $("#m-initial");
    const mInitialDate = $("#m-initial-date");
    const mCurrent = $("#m-current");
    const mAsOf    = $("#m-asof");
    const mGain    = $("#m-gain");
    const mGainPct = $("#m-gain-pct");
    const mCAGR    = $("#m-cagr");
    const mPeak    = $("#m-peak");
    const mPeakDate= $("#m-peak-date");
    const mDD      = $("#m-dd");
    const mDDPeriod= $("#m-dd-period");
    const scaleLinearBtn = $("#scale-linear");
    const scaleLogBtn    = $("#scale-log");
    const insightQuote = $("#insight-quote");
    const insightList  = $("#insight-list");

    // ========== Init inputs (range per PRD) ==========
    (function initInputs() {
      const now = new Date();
      const currentMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
      // PRD: max selectable is current month - 1
      const maxMonth = new Date(Date.UTC(currentMonth.getUTCFullYear(), currentMonth.getUTCMonth() - 1, 1));
      const minMonth = new Date(Date.UTC(2010, 0, 1)); // 2010-01

      function toYYYYMM(d) {
        return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}`;
      }

      dateEl.min = toYYYYMM(minMonth);
      dateEl.max = toYYYYMM(maxMonth);
      dateEl.value = "2020-01";

      amtEl.value = "10000";
      assetEl.value = "X:BTCUSD";
    })();

    // ========== Chart ==========
    let chart;
    let chartScale = "linear";

    function buildChart(labels, values, refLine) {
      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Portfolio Value",
              data: values,
              tension: 0.25,
              borderColor: "rgba(156,39,176,1)",
              backgroundColor: "rgba(156,39,176,0.15)",
              fill: true,
              borderWidth: 2
            },
            {
              label: "Initial Investment",
              data: refLine,
              borderDash: [6,6],
              borderColor: "rgba(255,255,255,0.35)",
              pointRadius: 0,
              fill: false,
              borderWidth: 1.5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.parsed.y;
                  return ` ${formatUSDFull(val)}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "rgba(255,255,255,0.7)" },
              grid:  { color: "rgba(255,255,255,0.08)" }
            },
            y: {
              type: chartScale,
              ticks: { color: "rgba(255,255,255,0.7)" },
              grid:  { color: "rgba(255,255,255,0.08)" }
            }
          }
        }
      });
    }

    // ========== Core calc ==========
    async function calculate() {
      try {
        // Reset UI state
        showError("");
        results.classList.remove("show");
        loading.classList.add("show");
        loading.setAttribute("aria-busy","true");
        calcBtn.disabled = true;

        // Validate inputs
        const yyyyMm = dateEl.value;
        const amount = Number(amtEl.value);
        const ticker = assetEl.value;

        if (!yyyyMm) throw new Error("Please select an investment month.");
        if (!(amount > 0) || amount > MAX_AMOUNT) throw new Error(`Amount must be between $1 and $${MAX_AMOUNT.toLocaleString()}.`);

        // Date range
        const fromStr = monthFirstDayStr(yyyyMm);
        const toStr = toISODate(new Date()); // today

        const fromDate = new Date(fromStr);
        const toDate   = new Date(toStr);
        if (fromDate >= toDate) throw new Error("Investment date must be before today.");

        // Fetch monthly aggregates from Polygon
        const url = `${POLY_ENDPOINT}/${encodeURIComponent(ticker)}/range/1/month/${fromStr}/${toStr}?apiKey=${POLY_API_KEY}&adjusted=true&sort=asc&limit=50000`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Polygon API error: ${res.status} ${res.statusText}`);
        const data = await res.json();

        if (!data.results || !data.results.length) {
          throw new Error("No data returned for that date/asset. Try a different month or asset.");
        }

        // Build value series
        const resultsArr = data.results; // each: { t, o, h, l, c, v, ... }
        const startPrice = resultsArr[0].c;
        const currentPrice = resultsArr[resultsArr.length - 1].c;
        if (!(startPrice > 0) || !(currentPrice > 0)) throw new Error("Invalid pricing data.");

        const shares = amount / startPrice;

        const labels = resultsArr.map(pt => {
          const d = new Date(pt.t);
          return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}`;
        });
        const values = resultsArr.map(pt => shares * pt.c);
        const refLine = values.map(_ => amount);

        // Metrics
        const currentValue = shares * currentPrice;
        const gain = currentValue - amount;
        const gainPct = (gain / amount) * 100;

        const years = Math.max( yearsBetween(new Date(resultsArr[0].t), new Date(resultsArr[resultsArr.length-1].t)), 0.00001);
        const cagr = (Math.pow(currentValue / amount, 1 / Math.max(years, 0.00001)) - 1) * 100;

        // Peak & drawdown
        let peak = -Infinity, peakIdx = -1, peakValAtIdx = 0;
        let maxDD = 0; // as positive percent
        let ddStartIdx = 0, ddEndIdx = 0;
        for (let i=0; i<values.length; i++) {
          const v = values[i];
          if (v > peak) { peak = v; peakIdx = i; }
          const dd = (peak - v) / peak; // fraction
          if (dd > maxDD) {
            maxDD = dd;
            ddStartIdx = peakIdx;
            ddEndIdx = i;
          }
        }

        // Best day (peak)
        const bestVal = Math.max(...values);
        const bestIdx = values.indexOf(bestVal);

        // Chart
        buildChart(labels, values, refLine);

        // Populate metrics
        mInitial.textContent = formatUSDFull(amount);
        mInitialDate.textContent = `On ${labels[0]}`;
        mCurrent.textContent = formatUSDFull(currentValue);
        mAsOf.textContent = `As of ${labels[labels.length-1]}`;

        const gainElClass = gain >= 0 ? "pos" : "neg";
        mGain.className = `metric-value ${gainElClass}`;
        mGain.textContent = (gain >= 0 ? "+" : "") + formatUSDFull(gain);
        mGainPct.className = gain >= 0 ? "pos" : "neg";
        mGainPct.textContent = fmtPct(gainPct);

        const cagrElClass = cagr >= 0 ? "pos" : "neg";
        mCAGR.className = `metric-value ${cagrElClass}`;
        mCAGR.textContent = isFinite(cagr) ? fmtPct(cagr) : "â€”";

        mPeak.textContent = formatUSDFull(bestVal);
        mPeakDate.textContent = `On ${labels[bestIdx]}`;

        const ddPct = -(maxDD * 100);
        mDD.textContent = fmtPct(ddPct);
        mDD.className = "metric-value neg";
        mDDPeriod.textContent = ddEndIdx > ddStartIdx ? `From ${labels[ddStartIdx]} to ${labels[ddEndIdx]}` : "â€”";

        // Insights
        buildInsights({
          ticker,
          amount,
          currentValue,
          gainPct,
          cagr,
          years,
          firstMonth: labels[0],
          lastMonth: labels[labels.length-1],
          bestVal,
          assetName: ASSET_NAMES[ticker] || ticker
        });

        // Show results
        results.classList.add("show");
      } catch (err) {
        showError(err.message || "Something went wrong.");
      } finally {
        loading.classList.remove("show");
        loading.setAttribute("aria-busy","false");
        calcBtn.disabled = false;
      }
    }

    function buildInsights({ ticker, amount, currentValue, gainPct, cagr, years, firstMonth, lastMonth, bestVal, assetName }) {
      // Quote (humorous per PRD)
      if (gainPct >= 0) {
        insightQuote.textContent = `â€œYou are an idiot for not investing in ${assetName} since it went up ${gainPct.toFixed(2)}%.â€`;
      } else {
        insightQuote.textContent = `â€œYou dodged a bullet by not investing in ${assetName} since it would have lost ${Math.abs(gainPct).toFixed(2)}%.â€`;
      }

      // Bullets
      const bullets = [];
      const multiple = currentValue / amount;
      if (multiple >= 2) bullets.push(`Thatâ€™s a ~${multiple.toFixed(2)}Ã— return from ${firstMonth} to ${lastMonth}.`);
      else if (multiple < 1) bullets.push(`Your money would be ${((1-multiple)*100).toFixed(1)}% smaller than the initial amount.`);

      if (isFinite(cagr)) {
        const cmpSP = 10; // rough long-term S&P CAGR benchmark
        if (cagr >= 20) bullets.push(`CAGR of ~${cagr.toFixed(2)}%/yr â€” thatâ€™s spicy (well above S&Pâ€™s long-run ~${cmpSP}%/yr).`);
        else if (cagr >= 10) bullets.push(`CAGR of ~${cagr.toFixed(2)}%/yr â€” roughly in S&P ballpark.`);
        else if (cagr < 0) bullets.push(`Negative CAGR (~${cagr.toFixed(2)}%/yr). Sometimes staying out really is a decision.`);
      }

      // Asset notes (simple, illustrative)
      if (ticker.startsWith("X:")) {
        bullets.push(`Crypto note: high volatility. Peaks and drawdowns can be extreme; timing matters a lot.`);
      } else if (ticker === "NVDA") {
        bullets.push(`NVDA note: AI/datacenter boom heavily influenced returns in recent years.`);
      } else if (ticker === "TSLA") {
        bullets.push(`TSLA note: major cycles tied to EV adoption, margins, and narrative risk.`);
      } else if (ticker === "SPY" || ticker === "QQQ") {
        bullets.push(`Index note: diversified exposure; typically lower single-asset risk, steadier CAGR.`);
      }

      // Daily average gain (approx)
      const days = Math.max(365.25 * years, 1);
      const avgDaily = (currentValue - amount) / days;
      bullets.push(`Avg change per day (rough): ${avgDaily >= 0 ? "+" : ""}${formatUSDFull(avgDaily)}.`);

      // Render
      insightList.innerHTML = "";
      bullets.forEach(b => {
        const li = document.createElement("li");
        li.textContent = b;
        insightList.appendChild(li);
      });
    }

    function showError(msg) {
      if (!msg) {
        errorBox.textContent = "";
        errorBox.classList.remove("show");
        return;
      }
      errorBox.textContent = msg;
      errorBox.classList.add("show");
    }

    // ========== Events ==========
    calcBtn.addEventListener("click", (e) => {
      e.preventDefault();
      calculate();
    });

    resetBtn.addEventListener("click", (e) => {
      e.preventDefault();
      // Defaults per PRD
      dateEl.value = "2020-01";
      amtEl.value = "10000";
      assetEl.value = "X:BTCUSD";
      showError("");
      results.classList.remove("show");
      // Auto recalc after reset for convenience
      calculate();
    });

    scaleLinearBtn.addEventListener("click", () => {
      if (chartScale !== "linear") {
        chartScale = "linear";
        setButtonActive(scaleLinearBtn, scaleLogBtn);
        // Re-scale without refetch: update chart config and re-render
        chart.options.scales.y.type = "linear";
        chart.update();
      }
    });
    scaleLogBtn.addEventListener("click", () => {
      if (chartScale !== "logarithmic" && chartScale !== "log") {
        chartScale = "logarithmic";
        setButtonActive(scaleLogBtn, scaleLinearBtn);
        chart.options.scales.y.type = "logarithmic";
        chart.update();
      }
    });

    // ========== Auto-calc on load ==========
    window.addEventListener("load", () => {
      calculate();
    });
  </script>
</body>
</html>
